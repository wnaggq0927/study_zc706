/* main.c */
#include "sys_core.h"
#include "FreeRTOS.h"
#include "task.h"
#include "xil_printf.h"
#include "lwip/sys.h"

void lwip_init();
void network_thread(void *p);

void main_thread(void *p) {
    xil_printf("\r\n--- System Booting ---\r\n");

    Init_All_Hardware();
    lwip_init();

    // 网络初始化线程
    sys_thread_new("NW_THRD", network_thread, NULL, 1024, DEFAULT_THREAD_PRIO);

    // UDP 监听线程
    sys_thread_new("UDP_THRD", udp_cmd_thread, NULL, 1024, DEFAULT_THREAD_PRIO);

    xil_printf(">> System Started. Launching Tasks...\r\n");

    // 【修复 2】 重新规划优先级 (数字越大，优先级越高)

    // 优先级 4 (最高): LED 任务，保证灯光绝对流畅，不卡顿
    xTaskCreate(Task_LED_Logic, "LED", 1024, NULL, tskIDLE_PRIORITY + 4, NULL);

    // 优先级 3: 串口命令任务，保证你能随时输入指令，不会被卡死
    // 【修复 3】 把这行加回来！之前漏了！
    xTaskCreate(Task_UART_Cmd, "CMD", 1024, NULL, tskIDLE_PRIORITY + 3, NULL);

    // 优先级 2: 系统监控，偶尔发个温度包，优先级中等
    xTaskCreate(Task_System_Monitor, "SysMon", 1024, NULL, tskIDLE_PRIORITY + 2, NULL);

    // 优先级 1 (最低): DMA 示波器任务
    // 它最占资源，让它只在 CPU 空闲时运行，这样就不会影响 LED 和串口了
    xTaskCreate(Task_DMA_Wave, "DMA", 2048, NULL, tskIDLE_PRIORITY + 1, NULL);

    vTaskDelete(NULL);
}

int main() {
    sys_thread_new("main_thrd", (void(*)(void*))main_thread, 0, 4096, DEFAULT_THREAD_PRIO);
    vTaskStartScheduler();
    while(1);
    return 0;
}
