#include "xaxidma.h"
#include "xparameters.h"
#include "xil_printf.h"
#include "xil_cache.h"

#define DMA_DEV_ID      XPAR_AXIDMA_0_DEVICE_ID
#define RX_BUFFER_BASE  0x10000000
#define MAX_PKT_LEN     (1024 * 4)

XAxiDma AxiDma;

int main()
{
    int Status;
    XAxiDma_Config *Config;
    Xil_DCacheDisable();
    xil_printf("\r\n--- DMA Debug Test ---\r\n");

    Config = XAxiDma_LookupConfig(DMA_DEV_ID);
    if (!Config) {
        xil_printf("No config found for %d\r\n", DMA_DEV_ID);
        return XST_FAILURE;
    }

    Status = XAxiDma_CfgInitialize(&AxiDma, Config);
    if (Status != XST_SUCCESS) {
        xil_printf("Initialization failed %d\r\n", Status);
        return XST_FAILURE;
    }

    XAxiDma_IntrDisable(&AxiDma, XAXIDMA_IRQ_ALL_MASK, XAXIDMA_DEVICE_TO_DMA);

    // ==========================================
    // 1. 【关键测试】先把内存填满 "DEADBEEF"
    // ==========================================
    u32 *RxBufferPtr = (u32 *)RX_BUFFER_BASE;
    for(int i=0; i<32; i++){
        RxBufferPtr[i] = 0xDEADBEEF;
    }

    // 2. 必须把这个 DEADBEEF 刷进 DDR，否则 DMA 可能会读到脏数据或者 CPU 以为还是 0
    Xil_DCacheFlushRange((UINTPTR)RxBufferPtr, MAX_PKT_LEN);

    // 3. 再次Invalidate，确保 CPU 接下来一定从 DDR 读（虽然现在还没跑 DMA）
    Xil_DCacheInvalidateRange((UINTPTR)RxBufferPtr, MAX_PKT_LEN);

    xil_printf(">> Memory filled with 0xDEADBEEF. Starting DMA...\r\n");

    // 4. 启动 DMA
    Status = XAxiDma_SimpleTransfer(&AxiDma, (UINTPTR)RxBufferPtr,
                                    MAX_PKT_LEN, XAXIDMA_DEVICE_TO_DMA);

    if (Status != XST_SUCCESS) {
        xil_printf("DMA Transfer Failed\r\n");
        return XST_FAILURE;
    }

    while (XAxiDma_Busy(&AxiDma, XAXIDMA_DEVICE_TO_DMA)) {}

    xil_printf(">> DMA Transfer Done!\r\n");

    // 5. 【核心步骤】Invalidate Cache
    // 告诉 CPU：“你缓存里的数据过期了，去 DDR 读 DMA 刚写进去的新数据！”
    Xil_DCacheInvalidateRange((UINTPTR)RxBufferPtr, MAX_PKT_LEN);

    // 6. 检查结果
    xil_printf(">> Checking Data:\r\n");
    int zero_count = 0;
    int beef_count = 0;

    for (int i = 0; i < 16; i++) {
        u32 val = RxBufferPtr[i];
        u8 sine_val = (u8)(val & 0xFF);

        xil_printf("Index %02d: Raw=0x%08X", i, val);

        if(val == 0xDEADBEEF) {
            xil_printf(" (DMA DID NOT WRITE!)\r\n");
            beef_count++;
        } else if (val == 0) {
            xil_printf(" (DMA Wrote ZERO)\r\n");
            zero_count++;
        } else {
            xil_printf(" (Success? Sine=%d)\r\n", sine_val);
        }
    }

    return XST_SUCCESS;
}
