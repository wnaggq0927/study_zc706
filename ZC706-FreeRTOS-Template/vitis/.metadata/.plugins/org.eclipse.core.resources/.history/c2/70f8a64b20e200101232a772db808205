#include "FreeRTOS.h"
#include "task.h"
#include "sys_core.h"
#include "xil_printf.h"
#include "xuartps_hw.h" // 串口底层驱动

// 全局变量定义（实体）
volatile LedMode_t g_CurrentMode = MODE_WATERFALL;

// 任务主函数
void Task_UART_Cmd(void *pvParameters)
{
    u8 RecvChar;
    // 获取标准输入的 UART 基地址 (通常是 STD_IN)
    u32 UartBaseAddr = STDIN_BASEADDRESS;

    xil_printf("\r\n=== Command Port Ready ===\r\n");
    xil_printf("Press '1': Waterfall\r\n");
    xil_printf("Press '2': Blink\r\n");
    xil_printf("Press '3': Breath\r\n");
    xil_printf("Press '0': Off\r\n");

    for (;;) {
        // 轮询检查串口是否有数据 (非阻塞式)
        // Check if RX FIFO is not empty
        if (XUartPs_IsReceiveData(UartBaseAddr)) {

            // 读取一个字节
            RecvChar = XUartPs_ReadReg(UartBaseAddr, XUARTPS_FIFO_OFFSET);

            // 解析指令
            switch(RecvChar) {
                case '1':
                    g_CurrentMode = MODE_WATERFALL;
                    xil_printf(">> Mode Set: Waterfall\r\n");
                    break;
                case '2':
                    g_CurrentMode = MODE_ALL_BLINK;
                    xil_printf(">> Mode Set: Blink\r\n");
                    break;
                case '3':
                    g_CurrentMode = MODE_BREATH_SIM;
                    xil_printf(">> Mode Set: Breath\r\n");
                    break;
                case '0':
                    g_CurrentMode = MODE_OFF;
                    xil_printf(">> Mode Set: OFF\r\n");
                    break;
                default:
                    // 忽略其他字符
                    break;
            }
        }

        // 稍微延时，避免轮询太快占用 CPU
        vTaskDelay(pdMS_TO_TICKS(50));
    }
}
